<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.benefit.mapper.BenefitActivityMapper">

    <update id="updateStatus">
        UPDATE benefit_activity
        <set>
            status = #{status},
            update_time = NOW(),
            <!-- 当状态变为 ENDED 时，自动设置结束时间为当前时间 -->
            <if test="status != null and status.name() == 'ENDED'">
                end_time = NOW(),
                remark = CONCAT(IFNULL(remark, ''), '手动结束于', NOW()),
            </if>
            <!-- 当状态变为 CANCELED 时，更新备注 -->
            <if test="status != null and status.name() == 'CANCELED'">
                remark = CONCAT(IFNULL(remark, ''), '手动取消于', NOW()),
            </if>
        </set>
        WHERE id = #{id}
        <!-- 添加状态流转保护 -->
        AND status NOT IN ('ENDED', 'CANCELED')
    </update>

    <!-- 查询过期活动 -->
    <select id="selectExpiredActivities" resultType="com.benefit.model.entity.BenefitActivity">
        SELECT id
        FROM benefit_activity
        WHERE status = 'ONGOING'
          AND end_time &lt;= NOW()
    </select>

    <!-- 查询要开始的活动 -->
    <select id="selectNotStartActivities" resultType="com.benefit.model.entity.BenefitActivity">
        SELECT id
        FROM benefit_activity
        WHERE status = 'NOT_STARTED'
          AND start_time &lt;= NOW()
        AND end_time > NOW()
    </select>

    <!-- 批量更新状态为结束 -->
    <update id="batchUpdateToEnded">
        UPDATE benefit_activity
        SET
        status = 'ENDED',
        update_time = NOW(),
        remark = CONCAT(IFNULL(remark, ''), '系统自动结束于', NOW())
        WHERE id IN
        <foreach collection="activities" item="activity" open="(" separator="," close=")">
            #{activity.id}
        </foreach>
    </update>


    <update id="batchUpdateToStart">
        UPDATE benefit_activity
        SET
        status = 'ONGOING',
        update_time = NOW(),
        remark = CONCAT(IFNULL(remark, ''), '系统自动开始于', NOW())
        WHERE id IN
        <foreach collection="activities" item="activity" open="(" separator="," close=")">
            #{activity.id}
        </foreach>
    </update>

</mapper>